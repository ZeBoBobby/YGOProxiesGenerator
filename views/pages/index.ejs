<!doctype html>
<html lang="<%= lang.includes('fr') ? 'fr' : 'en' %>">
  <head>
    <% 
      const pageTitle = 'YGOProxy.com - ' + (lang.includes('fr') ? 'Votre générateur de proxy YGO gratuit' : 'Your free YGO proxy generator');
      const pageDescription = lang.includes('fr') ? 'Générateur de proxy Yu-Gi-Oh! simple, gratuit et rapide. Créez des PDF de proxies à partir de fichiers YDK ou codes YDKE.' : 'Make Yu-Gi-Oh! proxies cards quickly, easily and for free. Create proxy PDFs from YDK files or YDKE codes.';
    %>
    <%- include('../partials/head', { title: pageTitle, description: pageDescription, canonical: 'https://ygoproxy.com/' }); %> 
    <style>
      .hero {
        text-align: center;
        margin-bottom: 2rem;
      }

      .intro-text {
        font-size: 1.15rem;
        color: var(--text-secondary);
        max-width: 700px;
        margin: 0 auto 2rem;
      }

      .new-badge {
        display: inline-block;
        background: linear-gradient(135deg, var(--accent-orange), #ff6b6b);
        color: white;
        padding: 0.4rem 1rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        margin: 1rem 0;
      }

      .new-badge a {
        color: white;
      }

      .form-container {
        max-width: 600px;
        margin: 0 auto;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text);
        font-size: 0.95rem;
      }

      input[type="file"],
      textarea {
        width: 100%;
        padding: 0.875rem;
        background: var(--bg);
        border: 2px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-family: inherit;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }

      input[type="file"]:focus,
      textarea:focus {
        outline: none;
        border-color: var(--accent-blue);
      }

      .divider {
        text-align: center;
        margin: 1.5rem 0;
        color: var(--text-secondary);
        font-size: 0.9rem;
      }

      .btn-submit {
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        font-family: inherit;
      }

      .btn-submit:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3);
      }

      .btn-submit:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .steps-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin: 0.75rem 0;
      }

      .step-item {
        text-align: center;
        padding: 1rem;
        border-radius: 8px;
        transition: all 0.3s ease;
        cursor: default;
      }

      .step-item:hover {
        background: var(--bg);
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.15);
      }

      .step-icon {
        width: 60px;
        height: 60px;
        margin: 0 auto 1rem;
        background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
      }

      .donation-section {
        text-align: center;
        padding: 2rem;
        margin-top: 2rem;
      }

      .donation-text {
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
        font-size: 1rem;
      }

      .error-message {
        color: #ff6b6b;
        margin-top: 0.5rem;
        font-size: 0.9rem;
      }

      .remember-checkbox {
        margin: 1rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        background: var(--bg);
        border-radius: 8px;
        border: 2px solid var(--border);
      }

      .remember-checkbox input[type="checkbox"] {
        width: auto;
        margin: 0;
        cursor: pointer;
      }

      .remember-checkbox label {
        margin: 0;
        font-weight: 500;
        font-size: 0.9rem;
        cursor: pointer;
        flex: 1;
      }

      .remember-checkbox .new-badge-inline {
        display: inline-block;
        background: linear-gradient(135deg, var(--accent-orange), #ff6b6b);
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-right: 0.5rem;
      }

      .history-section {
        margin-top: 1.5rem;
        padding: 1rem;
        background: var(--bg);
        border-radius: 8px;
        border: 2px solid var(--border);
      }

      .history-section h3 {
        margin: 0 0 1rem 0;
        font-size: 1rem;
        color: var(--text);
      }

      .history-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .history-item {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: var(--bg);
        border-radius: 6px;
        border: 1px solid var(--border);
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
      }

      .history-item:hover {
        background: rgba(74, 144, 226, 0.05);
        border-color: var(--accent-blue);
      }

      .history-item-content {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .history-item a {
        color: var(--accent-blue);
        text-decoration: none;
        font-weight: 500;
        flex: 1;
      }

      .history-item a:hover {
        text-decoration: underline;
      }

      .history-item .date {
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .history-item-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .history-item-icon {
        width: 20px;
        height: 20px;
        cursor: pointer;
        color: var(--text-secondary);
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .history-item-icon:hover {
        color: var(--accent-blue);
        transform: scale(1.1);
      }

      .history-item-icon.delete:hover {
        color: #ff6b6b;
      }

      .history-item-icon svg {
        width: 100%;
        height: 100%;
      }

      .history-empty {
        color: var(--text-secondary);
        font-size: 0.9rem;
        text-align: center;
        padding: 1rem;
      }

      @media (max-width: 768px) {
        .steps-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <%- include('../partials/header'); %> 

    <div class="wrapper">
      <div class="hero">
        <h1><%= lang.includes('fr') ? 'Bienvenue sur YGOProxy !' : 'Welcome to YGOProxy!'%></h1>
        <p class="intro-text">
          <%= lang.includes('fr') ? 'Cet outil très simple va te permettre de générer automatiquement et très facilement un fichier PDF de proxies prêt à imprimer, à partir d\'un simple fichier YDK ou en entrant le code YDKE.' : 'This simple tool will allow you to convert automatically and very easily an YDK decklist into a ready-to-print proxy PDF file, or by entering the YDKE code.' %>
        </p>
        <div class="new-badge">
          <span><%= lang.includes('fr') ? 'Nouveau : ' : 'New: ' %></span>
          <%- lang.includes('fr') ? 'Tu peux aussi utiliser notre <a href="/calculator">calculatrice partagée</a> pour suivre tes points de vie en temps réel avec ton adversaire pendant tes matchs, ou directement sur <a href="https://calc.ygoproxy.com" target="_blank" rel="noopener noreferrer">calc.ygoproxy.com</a> !' : 'You can also use our <a href="/calculator">shared calculator</a> to track your life points in real-time with your opponent during your matches, or directly on <a href="https://calc.ygoproxy.com" target="_blank" rel="noopener noreferrer">calc.ygoproxy.com</a>!' %>
        </div>
      </div>

      <div class="content-box form-container">
        <form action="/upload-decklist" method="post" enctype="multipart/form-data" id="proxyForm">
          <div class="form-group">
            <label for="deckfile"><%= lang.includes('fr') ? 'Fichier YDK :' : 'YDK File:' %></label>
            <input type="file" name="deckfile" id="deckfile" accept=".ydk">
          </div>
          <div class="divider">- <%= lang.includes('fr') ? 'OU' : 'OR' %> -</div>
          <div class="form-group">
            <label for="ydkeCode"><%= lang.includes('fr') ? 'Code YDKE :' : 'YDKE Code:' %></label>
            <textarea name="ydkeCode" id="ydkeCode" rows="4" placeholder="ydke://..."></textarea>
          </div>
          <div class="error-message" id="errorMessage"></div>
          <div class="remember-checkbox">
            <input type="checkbox" id="dontRemember" name="dontRemember">
            <label for="dontRemember">
              <span class="new-badge-inline"><%= lang.includes('fr') ? 'Nouveau !' : 'New!' %></span>
              <%= lang.includes('fr') ? 'Ne pas se souvenir des proxy créés' : 'Do not remember created proxies' %>
            </label>
          </div>
          <button type="submit" class="btn-submit" id="proxyButton" disabled>
            <%= lang.includes('fr') ? 'Proxyfier !' : 'Proxify!' %>
          </button>
        </form>
      </div>

      <div class="content-box history-section" id="historySection" style="display: none; margin-top: 1.5rem;">
        <h3><%= lang.includes('fr') ? 'Vos proxies précédents' : 'Your previous proxies' %></h3>
        <ul class="history-list" id="historyList">
          <li class="history-empty"><%= lang.includes('fr') ? 'Chargement...' : 'Loading...' %></li>
        </ul>
      </div>

      <div class="content-box" style="margin-top: 1.5rem; padding: 1.5rem;">
        <div class="steps-grid">
          <div class="step-item">
            <div class="step-icon">1</div>
            <p><%= lang.includes('fr') ? 'Choisis ton fichier YDK ou code YDKE' : 'Choose your YDK file or YDKE code' %></p>
          </div>
          <div class="step-item">
            <div class="step-icon">2</div>
            <p><%= lang.includes('fr') ? 'Clique sur "Proxyfier !"' : 'Click "Proxify!"' %></p>
          </div>
          <div class="step-item">
            <div class="step-icon">3</div>
            <p><%= lang.includes('fr') ? 'Télécharge ton PDF' : 'Download your PDF' %></p>
          </div>
          <div class="step-item">
            <div class="step-icon">4</div>
            <p><%= lang.includes('fr') ? 'Kiff tes proxy ;)' : 'Enjoy your proxies ;)' %></p>
          </div>
        </div>
      </div>

      <div class="content-box donation-section">
        <p class="donation-text">
          <%= lang.includes('fr') ? 'Si cet outil t\'a aidé à créer tes proxies, n\'hésites pas à me payer un café ou à m\'aider à commander des staple sur Cardmarket ! ☕' : 'If this tool helped you create your proxies, feel free to buy me a coffee or help me order some staples on Cardmarket! ☕' %>
        </p>
        <a href="https://www.buymeacoffee.com/BoBobby" target="_blank" rel="noopener noreferrer">
          <img src="https://img.buymeacoffee.com/button-api/?text=Buy me a coffee&emoji=&slug=BoBobby&button_colour=FFDD00&font_colour=000000&font_family=Poppins&outline_colour=000000&coffee_colour=ffffff" alt="Buy me a coffee">
        </a>
      </div>
    </div>

    <%- include('../partials/footer'); %> 

    <script>
      const deckfileInput = document.getElementById('deckfile');
      const ydkeInput = document.getElementById('ydkeCode');
      const proxyButton = document.getElementById('proxyButton');
      const errorMessage = document.getElementById('errorMessage');
      const dontRememberCheckbox = document.getElementById('dontRemember');
      const historySection = document.getElementById('historySection');
      const historyList = document.getElementById('historyList');
      const isFr = '<%= lang.includes("fr") %>' === 'true';

      const STORAGE_KEY = 'ygoproxy_history';
      const DONT_REMEMBER_KEY = 'ygoproxy_dont_remember';

      // Charger l'état de la case à cocher
      const savedDontRemember = localStorage.getItem(DONT_REMEMBER_KEY) === 'true';
      if (savedDontRemember) {
        dontRememberCheckbox.checked = true;
      }

      // Gérer le changement de la case à cocher
      dontRememberCheckbox.addEventListener('change', function() {
        if (this.checked) {
          localStorage.setItem(DONT_REMEMBER_KEY, 'true');
          // Vider l'historique si l'utilisateur coche la case
          localStorage.removeItem(STORAGE_KEY);
          loadHistory();
        } else {
          localStorage.removeItem(DONT_REMEMBER_KEY);
        }
      });

      // Sauvegarder l'état de la case avant la soumission du formulaire
      document.getElementById('proxyForm').addEventListener('submit', function() {
        // L'état est déjà sauvegardé dans le change event, mais on s'assure qu'il est à jour
        if (dontRememberCheckbox.checked) {
          localStorage.setItem(DONT_REMEMBER_KEY, 'true');
        } else {
          localStorage.removeItem(DONT_REMEMBER_KEY);
        }
      });

      function updateButtonState() {
        const hasFile = deckfileInput.files.length > 0;
        const hasCode = ydkeInput.value.trim().length > 0;

        if ((hasFile && hasCode) || (!hasFile && !hasCode)) {
          proxyButton.disabled = true;
          errorMessage.textContent = isFr 
            ? 'Veuillez fournir uniquement un fichier YDK ou un code YDKE.' 
            : 'Please provide either a YDK file or a YDKE code, not both.';
        } else if (hasFile || hasCode) {
          proxyButton.disabled = false;
          errorMessage.textContent = '';
        } else {
          proxyButton.disabled = true;
          errorMessage.textContent = isFr 
            ? 'Veuillez fournir un fichier YDK ou un code YDKE.' 
            : 'Please provide a YDK file or a YDKE code.';
        }
      }

      // Fonction pour formater la date
      function formatDate(dateString) {
        const date = new Date(dateString);
        if (isFr) {
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = date.getFullYear();
          return `${day}-${month}-${year}`;
        } else {
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = date.getFullYear();
          return `${month}-${day}-${year}`;
        }
      }

      // Charger et afficher l'historique
      async function loadHistory() {
        // Vérifier si l'utilisateur ne veut pas se souvenir
        if (localStorage.getItem(DONT_REMEMBER_KEY) === 'true') {
          historySection.style.display = 'none';
          return;
        }

        const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        
        if (history.length === 0) {
          historySection.style.display = 'none';
          return;
        }

        // Trier par date (plus récent en premier)
        history.sort((a, b) => new Date(b.date) - new Date(a.date));

        // Vérifier quels PDFs existent encore
        const filenames = history.map(item => item.filename);
        
        try {
          const response = await fetch('/api/check-pdfs', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ filenames })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          const results = data.results || {};

          // Filtrer uniquement les PDFs qui existent encore
          const availableHistory = history.filter(item => results[item.filename] === true);

          if (availableHistory.length === 0) {
            historySection.style.display = 'none';
            // Nettoyer le localStorage des PDFs qui n'existent plus
            localStorage.removeItem(STORAGE_KEY);
            return;
          }

          // Mettre à jour le localStorage avec seulement les PDFs disponibles
          localStorage.setItem(STORAGE_KEY, JSON.stringify(availableHistory));

          // Afficher l'historique
          displayHistory(availableHistory);
          historySection.style.display = 'block';
        } catch (error) {
          // En cas d'erreur, afficher quand même l'historique sans vérification
          displayHistory(history);
          historySection.style.display = 'block';
        }
      }

      // Fonction pour afficher l'historique
      function displayHistory(historyItems) {
        historyList.innerHTML = '';
        historyItems.forEach(item => {
          const li = document.createElement('li');
          li.className = 'history-item';
          
          // Contenu principal (lien + date)
          const contentDiv = document.createElement('div');
          contentDiv.className = 'history-item-content';
          
          const link = document.createElement('a');
          link.href = item.filename;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.textContent = item.filename;
          
          const dateSpan = document.createElement('span');
          dateSpan.className = 'date';
          dateSpan.textContent = `(${formatDate(item.date)})`;
          
          contentDiv.appendChild(link);
          contentDiv.appendChild(dateSpan);
          
          // Actions (icônes)
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'history-item-actions';
          
          // Icône copier
          const copyIcon = document.createElement('div');
          copyIcon.className = 'history-item-icon copy';
          copyIcon.title = isFr ? 'Copier l\'URL' : 'Copy URL';
          copyIcon.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
              <path d="M5 15H4C2.89543 15 2 14.1046 2 13V4C2 2.89543 2.89543 2 4 2H13C14.1046 2 15 2.89543 15 4V5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            </svg>
          `;
          copyIcon.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const url = window.location.origin + '/' + item.filename;
            navigator.clipboard.writeText(url).then(() => {
              // Feedback visuel temporaire
              const originalTitle = copyIcon.title;
              copyIcon.title = isFr ? 'Copié !' : 'Copied!';
              copyIcon.style.color = 'var(--accent-blue)';
              setTimeout(() => {
                copyIcon.title = originalTitle;
                copyIcon.style.color = '';
              }, 1000);
            });
          });
          
          // Icône supprimer
          const deleteIcon = document.createElement('div');
          deleteIcon.className = 'history-item-icon delete';
          deleteIcon.title = isFr ? 'Supprimer de l\'historique' : 'Remove from history';
          deleteIcon.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
              <path d="M10 11V17M14 11V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            </svg>
          `;
          deleteIcon.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            // Supprimer de l'historique
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const updatedHistory = history.filter(h => h.filename !== item.filename);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(updatedHistory));
            // Recharger l'historique
            loadHistory();
          });
          
          actionsDiv.appendChild(copyIcon);
          actionsDiv.appendChild(deleteIcon);
          
          li.appendChild(contentDiv);
          li.appendChild(actionsDiv);
          historyList.appendChild(li);
        });
      }

      // Charger l'historique au chargement de la page
      loadHistory();

      deckfileInput.addEventListener('change', updateButtonState);
      ydkeInput.addEventListener('input', updateButtonState);
    </script>
  </body>
</html>

